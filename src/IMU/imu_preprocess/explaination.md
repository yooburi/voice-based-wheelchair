# IMU 과정처리 노드 (imu_preprocess_node) 알고리즘 설명

## 1. 개요

`imu_preprocess_node`는 관성 측정 장치(IMU) 센서로부터 수신한 원시(raw) 데이터를 처리하여 더 정확하고 안정적인 데이터를 제공하는 ROS 2 노드입니다. IMU 센서 측정값에 포함된 **바이어스(Bias)**와 **노이즈(Noise)**를 제거하여, 후속 작업인 로봇의 위치 및 자세 추정 성능을 향상시키는 것을 목표로 합니다.

이 노드는 다음과 같은 두 가지 핵심 전처리 단계를 순차적으로 수행합니다.

1.  **정적 캘리브레이션 (Static Calibration)**: 노드 시작 시 일정 시간 동안 센서의 바이어스를 측정하고 제거합니다.
2.  **저역 통과 필터링 (Low-Pass Filtering)**: 바이어스가 제거된 데이터에서 고주파 노이즈를 감쇠시킵니다.

---

## 2. 아키텍처 및 데이터 흐름

```
        +------------------------------------------+
        |               ROS 2 시스템                 |
        |                                          |
        |     /imu/data (sensor_msgs/msg/Imu)      |
        |                   |                      |
        +-------------------v----------------------+
                            |
                            v
              +-----------------------------+
              |     imu_preprocess_node     |
              +-----------------------------+
                            |
              +-----------------------------+
              |    캘리브레이션 완료 여부 확인    |
              +-----------------------------+
                      /            \
                 No  /              \  Yes
                    v                v
    +-----------------------------------------+
    |   정적 캘리브레이션 단계 (accumulateBias)    |
    |   - 정지 상태 데이터 누적                   |
    |   - Z축 가속도에서 중력값 제거 포함           |
    +-----------------------------------------+
                    |
        [지정된 시간 경과? 확인]
                    |
                    v
    +------------------------------------+
    |      평균 편향 계산 (finalizeBias)    |
    +------------------------------------+
                    |
                    v
    +--------------------------------+
    |          편향(Bias) 제거         |
    +--------------------------------+
                    |
                    v
    +-----------------------------------------+
    |     저역 통과 필터 (LPF) 적용               |
    +-----------------------------------------+
                    |
                    v
        +-------------------------------+
        |   /imu/processed 토픽 발행      |
        |   (sensor_msgs/msg/Imu)       |
        +-------------------------------+

```

| 단계 | 설명 |
|------|------|
| **입력** | `/imu/data` 토픽에서 원시 IMU 데이터를 구독합니다. |
| **분기** | 캘리브레이션이 완료되었는지 확인합니다. |
| **캘리브레이션** | (미완료 시) 지정된 시간(`calib_duration`) 동안 데이터를 수집하여 평균 바이어스를 계산합니다. |
| **편향 제거** | (완료 시) 측정값에서 계산된 바이어스 값을 빼줍니다. |
| **필터링** | 바이어스가 제거된 데이터에 저역 통과 필터를 적용하여 노이즈를 제거합니다. |
| **출력** | 전처리가 완료된 데이터를 `/imu/processed` 토픽으로 발행합니다. |

---

## 3. 알고리즘 상세 설명

### 3.1. 1단계: 정적 캘리브레이션 (편향 제거)

**목표**  
센서가 정지 상태일 때도 0이 아닌 값을 출력하는 **고정 오차(바이어스)**를 제거합니다.

**원리**  
완벽한 IMU는 정지 상태에서 각속도는 0 rad/s, 가속도는 중력 방향(Z축)으로만 9.81 m/s²를 측정해야 합니다. 하지만 실제 센서는 바이어스로 인해 다른 값을 출력합니다. 이 노드는 시작 후 `calib_duration` 동안 센서가 정지해 있다고 가정하고, 이 기간 동안 측정된 값들의 평균을 구해 바이어스로 간주합니다.

**구현**  
- accumulateBias: `calib_duration` 동안 들어오는 모든 IMU 데이터의 가속도와 각속도 값을 각각 `sum_acc_`, `sum_gyro_`에 더함  
- Z축 가속도는 순수 바이어스만 측정하기 위해 측정값에서 중력 가속도(9.81)를 미리 빼고 누적  
- finalizeBias: `calib_duration`이 지나면 누적된 값을 샘플 수로 나누어 평균 바이어스(`bias_acc_`, `bias_gyro_`)를 계산  
- 편향 제거: 캘리브레이션 완료 후, 새로 들어오는 모든 측정값에서 이 바이어스를 빼줌

---

### 3.2. 2단계: 1차 IIR 저역 통과 필터 (노이즈 제거)

**목표**  
모터 진동 등 외부 요인에 의해 발생하는 고주파 노이즈를 제거하여 데이터를 부드럽게 만듭니다.

**원리**  
저역 통과 필터(Low-Pass Filter, LPF)는 설정된 차단 주파수보다 낮은 주파수의 신호는 통과시키고, 높은 주파수의 신호는 감쇠시킵니다. 로봇의 실제 움직임은 비교적 저주파 신호이고, 불규칙한 노이즈는 고주파 신호인 경우가 많아 이 필터를 통해 효과적으로 노이즈를 걸러낼 수 있습니다.

이 노드에서는 연산량이 적고 실시간 처리에 유리한 1차 IIR 필터를 사용합니다.

**구현**  
- 필터 계수 alpha 계산:

```cpp
const double tau   = 1.0 / (2.0 * M_PI * lpf_cutoff_);
const double alpha = dt / (tau + dt);
```

- 필터링 적용:

```cpp
// y: 현재 필터링된 값, x: 현재 측정값, prev: 이전 필터링된 값
y = alpha * x + (1.0 - alpha) * prev;
```

- alpha가 클수록 현재 측정값의 비중이 높아져 응답이 빨라지고, 작을수록 이전 값의 비중이 높아져 더 부드러운 신호를 얻습니다.
- 이 계산을 가속도 및 각속도의 모든 축에 적용합니다.

---

## 4. 결론

`imu_preprocess_node`는 정적 캘리브레이션과 저역 통과 필터링이라는 두 가지 핵심 단계를 통해 IMU 데이터의 정확성과 안정성을 크게 향상시킵니다. 잘 전처리된 IMU 데이터는 로봇의 위치 추정, 자세 제어 등 후속 알고리즘의 성능을 극대화하는 데 필수적인 요소입니다.